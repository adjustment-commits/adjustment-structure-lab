<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<title>Kinetic Pro Structure Lab</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

html,body{
margin:0;
padding:0;
width:100%;
height:100%;
background:#000;
color:#fff;
font-family:sans-serif;
overflow:hidden;
}

/* 全体 */
#layout{
display:flex;
flex-direction:column;
height:100vh;
}

/* 上段 */
.header{
flex:0 0 auto;
display:flex;
gap:10px;
padding:10px;
background:#111;
border-bottom:1px solid #333;
}

.top-btn{
flex:1;
height:42px;
background:#333;
color:#fff;
border:1px solid #555;
border-radius:8px;
font-weight:bold;
}

/* ===== 映像エリア ===== */
.main{
flex:1 1 auto;
position:relative;
display:flex;
justify-content:center;
align-items:center;
background:#000;
}

canvas{
width:100%;
height:100%;
object-fit:contain;
}

/* 角度表示 */
.badges{
position:absolute;
top:10px;
left:10px;
}

.badge{
background:rgba(0,0,0,0.7);
padding:6px 10px;
margin-bottom:6px;
border-left:4px solid #00ffcc;
font-size:12px;
}

/* ===== 下段操作 ===== */
.deck{
flex:0 0 auto;
background:#111;
border-top:1px solid #333;
padding:10px;
}

.play{
width:60px;
height:60px;
border-radius:50%;
font-size:28px;
background:#00ffcc;
border:none;
}

/* スライダー */
input[type=range]{
width:100%;
height:30px;
accent-color:#00ffcc;
}

/* 録画 */
.rec{
margin-top:8px;
width:100%;
height:42px;
background:#441111;
color:#ff4444;
border:2px solid #ff4444;
border-radius:8px;
font-weight:bold;
}

.rec-active{
background:#ff4444!important;
color:#fff!important;
}
</head>

<body>

<div id="layout">

<div class="header">
<label class="top-btn">
動画選択
<input type="file" id="up" accept="video/*" hidden>
</label>

<select id="mode" class="top-btn">
<option value="pitch">投球</option>
<option value="bat">打撃</option>
</select>
</div>

<div class="main">
<canvas id="cv"></canvas>

<div class="badges">
<div id="a1" class="badge">胸郭×骨盤：--</div>
<div id="a2" class="badge">胸郭×上腕：--</div>
<div id="a3" class="badge">骨盤×上腕：--</div>
</div>
</div>

<div class="deck">

<button id="pp" class="play">▶</button>

<div>
<span id="cn">0.00</span> /
<span id="tn">0.00</span>s
<input type="range" id="sk" step="0.001">
</div>

<br>
<button id="recBtn" class="rec">解析映像保存</button>

</div>

</div>

<video id="vd" playsinline muted hidden></video>

<script>

/* ---------- DOM ---------- */

const vd=document.getElementById("vd");
const cv=document.getElementById("cv");
const ctx=cv.getContext("2d");
const sk=document.getElementById("sk");
const pp=document.getElementById("pp");

const a1=document.getElementById("a1");
const a2=document.getElementById("a2");
const a3=document.getElementById("a3");

/* ---------- utility ---------- */

function vec(a,b){return{x:b.x-a.x,y:b.y-a.y};}
function mag(v){return Math.sqrt(v.x*v.x+v.y*v.y);}
function dot(a,b){return a.x*b.x+a.y*b.y;}
function angle(v1,v2){
const c=dot(v1,v2)/(mag(v1)*mag(v2));
return Math.acos(Math.min(Math.max(c,-1),1))*180/Math.PI;
}

/* ---------- MediaPipe ---------- */

const pose=new Pose({
locateFile:(f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
});

pose.setOptions({
modelComplexity:1,
smoothLandmarks:true,
minDetectionConfidence:0.5,
minTrackingConfidence:0.5
});

pose.onResults(r=>{
if(!r.image)return;

cv.width=r.image.width;
cv.height=r.image.height;

ctx.clearRect(0,0,cv.width,cv.height);
ctx.drawImage(r.image,0,0,cv.width,cv.height);

if(!r.poseLandmarks)return;
const lm=r.poseLandmarks;

/* vectors */
const thorax=vec(lm[11],lm[12]);
const pelvis=vec(lm[23],lm[24]);
const arm=vec(lm[12],lm[14]);

const angTP=angle(thorax,pelvis);
const angTA=angle(thorax,arm);
const angPA=angle(pelvis,arm);

a1.innerText=`胸郭×骨盤：${angTP.toFixed(1)}°`;
a2.innerText=`胸郭×上腕：${angTA.toFixed(1)}°`;
a3.innerText=`骨盤×上腕：${angPA.toFixed(1)}°`;

/* draw */
draw(lm[11],lm[12],"#00ffff",6);
draw(lm[23],lm[24],"#00ff00",6);
draw(lm[12],lm[14],"#ffcc00",8);
});

/* ---------- draw ---------- */

function draw(a,b,c,w){
ctx.beginPath();
ctx.moveTo(a.x*cv.width,a.y*cv.height);
ctx.lineTo(b.x*cv.width,b.y*cv.height);
ctx.strokeStyle=c;
ctx.lineWidth=w;
ctx.stroke();
}

/* ---------- loop ---------- */

let seeking=false;

async function loop(){
if(!vd.paused||seeking){
await pose.send({image:vd});
if(!seeking){
sk.value=vd.currentTime;
document.getElementById("cn").innerText=vd.currentTime.toFixed(2);
}
}
requestAnimationFrame(loop);
}

/* ---------- controls ---------- */

pp.onclick=()=>{
if(vd.paused){
vd.play();pp.innerText="‖";
}else{
vd.pause();pp.innerText="▶";
}
};

sk.oninput=()=>{
vd.currentTime=sk.value;
seeking=true;
};

sk.onchange=()=>{seeking=false;};

document.getElementById("up").onchange=e=>{
const f=e.target.files[0];
if(!f)return;
vd.src=URL.createObjectURL(f);
vd.onloadedmetadata=()=>{
sk.max=vd.duration;
document.getElementById("tn").innerText=vd.duration.toFixed(2);
vd.play();
pp.innerText="‖";
loop();
};
};

/* ---------- recording ---------- */

let recorder;
let chunks=[];

document.getElementById("recBtn").onclick=()=>{
const btn=document.getElementById("recBtn");

if(!recorder||recorder.state==="inactive"){
chunks=[];
const stream=cv.captureStream(30);
recorder=new MediaRecorder(stream,{mimeType:"video/webm"});
recorder.ondataavailable=e=>chunks.push(e.data);
recorder.onstop=()=>{
const blob=new Blob(chunks,{type:"video/webm"});
const url=URL.createObjectURL(blob);
const a=document.createElement("a");
a.href=url;
a.download="analysis_video.webm";
a.click();
};
recorder.start();
btn.classList.add("rec-active");
btn.innerText="録画停止 → 保存";
}else{
recorder.stop();
btn.classList.remove("rec-active");
btn.innerText="解析映像保存";
}
};

</script>

</body>
</html>
